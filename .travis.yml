language: android
sudo: false
jdk: oraclejdk8

before_cache:
  - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/

env:
  global:
  - APP_NAME=aardvark
  - ANDROID_API=26
  - ANDROID_BUILD_TOOLS=26.0.1
  - ADB_INSTALL_TIMEOUT=5
  - secure: cZgR8Sy9tuOaeKgE+p45ZxgLyMaLlKMWi/tBHy26yLNn15JcFG05SDl41p2Nx9vamytLymTIivywBPmh6M+QEHP9PBuRI0qqhwB95p5HjQ24PqzjU5PEXTg43YNFVt5PTp4oMFNEia92DZUi+2kri031n/wIdw/qcCltzMg9eDQqbrUefOBY7vHdKbax5j2g7pX30pgf7LaQzu5Z5PFJ246eI/yChSolxjaUQjPJzdP41B5Vq8NmiZbtIivfI3u+MrXGvOY/eRCzBRXLjQeFeFgXu4rvYV8KhsOij+AT0OgMXjTWnWVnCE8C6Ui+Y/h3yaKBFYNOhfi6ZiBUWL9VwZEdhdsWJwx9zyhnXXtxt6Z8y0+x+wdQjP8Ybc2FgFNUtuYVQC8mJ1t/LMuVyue2jjBgNjQQjQE8er8ZU9AXPiDYLpDGl1KXrCJ360t/9XxZqXBfLpFuDSsZP5BCGhxEFvXO3cD+TkY+YzTDrScQgsG9EDkNTRD6VhC9crBCJ1BUDXACRSqcdpJRfREPF4gHyAB3Ilc5EX/9DpMgaQ3mNlEouUI5efzREVsxUzAnljo9B8Er0R2q74P11VcyOzDSkqVwIKH1aS4ydVopJrrzUj/M+dRgy2GxEDZH/CELBX2QyFwb+Q8gDDNMdOkcQAYAQ02RNrD0vVLZH36RpmeGsCU=
  - secure: EiPY8Vgxpr8l294VniV0fTtd7jkuIGz2KFipjCeVLlGVrSLVI77/1dT+qdxpCdToaum3eWPXB2M8Xao7CGEs+/3D0+hDjCj/hEF+sPHhfb7oK7NNldQI49HIQg8dhh0pXSnyRpYAL/Guw8I+wohD3tVHA7tGcXpUrmelpO5I/U7pNjDrimELnCJzSsPFvqq78zyND3NyELqj/Qr4E0i6OiagnQA+5XV/OkUEPoOGbws/1NmcX0NxlWLhHl+yzw3xQ0QvSeg9hkgtIC8rBBcMJjYKNCy1/prHvmiaJKDF2AU43/6OXVG6YS39WQam8CRbFeWfRw+rg3ZH8/ukHmVo3swuU8bammlhA+l6xlQzTpMLeUC7SmKEkV5bdZtDxxwC3ZZc31/ernmp2FfRWVXozktwnAlJouSdMJojNMrmiOSl2of7Z5jqEkJP/cAXNKeJT2SZrcgPjOp+Pv79XsWPFYXzKy9uqAEQmwvLjjsvUtEixzLrFdo1iqtvLgIoPplzPqV5+UaGL8H9yo8lCf6zWnxPf1R2//hneslPdpkecokbVy0HfWdX+92+BGFoNH5f+2Lvg7TdTaAC1bjF5l0WTRWK5fz+z3qbhuj6N0nbAVyEWZvxu1LtRhzbhImCnOpDsJ3/IAkSoU+DDWvgoQ1iPW4+j8El77VJPjVWWmppbUs=

android:
  components:
  - tools
  - platform-tools
  - build-tools-$ANDROID_BUILD_TOOLS
  - android-$ANDROID_API
  - extra-android-support
  - extra-google-google_play_services

  licenses:
  - android-sdk-preview-license-.+
  - android-sdk-license-.+
  - google-gdk-license-.+

before_install:
  - openssl aes-256-cbc -K $encrypted_7b7d53b231fa_key -iv $encrypted_7b7d53b231fa_iv -in secrets.tar.enc -out secrets.tar -d
  - tar xvf secrets.tar
  - mv production.jks app
  - mkdir "$ANDROID_HOME/licenses" || true
  - echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > "$ANDROID_HOME/licenses/android-sdk-license"
  - echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
  - chmod +x gradlew

script:
  - ./gradlew clean build connectedCheck

#before_deploy:
#  - cp $TRAVIS_BUILD_DIR/app/production.jks $HOME
#  - cd app/build/outputs/apk/
#  - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore $HOME/production.jks -storepass $storepass -keypass $keypass ${APP_NAME}-${TRAVIS_TAG}-release.apk production
#  - jarsigner -verify ${APP_NAME}-${TRAVIS_TAG}-release.apk
#  - ${ANDROID_HOME}/build-tools/${ANDROID_BUILD_TOOLS}/zipalign -v 4 ${APP_NAME}-${TRAVIS_TAG}-release.apk

deploy:
  provider: releases
  file: ${APP_NAME}-${TRAVIS_TAG}.apk
  skip_cleanup: true

  on:
    repo: Thames1990/aardvark
    tags: true
    jdk: oraclejdk8

  api_key:
    secure: YaOjd2J3rFjldscJwCn0eclpl3ck7tBHcJ6rnGLY5ggBNfRgie45FzdrTLMYgfUGZcDbMHTi4GU8n38rjLY5CrgoN0sCcMy1V5hN76QQL5DsJq14MQ6qeXlNmjo5A9kUMBNxcb9G6VkPN0o3ioWC31sJZbGzafy8HZaBbSlba0Nf2/HkA93yaChY0A75apcQx/hMTCDDETbdkUgFkVp5/YA0uaJPprgRbSCpiAENmM7Ncz51AULpMR+FrePTIyJhuG0PnlKwdkExhpDrCql9dql90OMGuS6t0ErsQkjModMjFue63wB6tlGotmOG+9u9ZxDK3FuqJmweLeE3Eg0Dvs+DI9DFmHjDGNShRgsO0foOuThFoRB10VT+CgAXnqvqRJ7y3e5voK35r09rP8UdX5FUotdH1ayaVO/DafACbQvaIJKZY7ezNkfvi8t5Sl893C+4XiLRRsFtvoGJeCCFx3su9CVjHE5furpB/d/YRV8RXjCmFviAIUES2T+R233vRmPSNIDVoTKZxGj9OyQx6JgqeL7TkySqCrXvYTpw2jnQtzHiEPtgTewc5lSf4+2rXYfesmlrnrQm/jLTbdIXZjoHu5bH9qlZOKODhQAjBD2uFdhM+ZiROHP3S2RYJMH3PUU6BuwGhlh4CcNm88a28pOSr3GNsW+gbrgKKPQdDKk=
